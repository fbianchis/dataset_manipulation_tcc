                                                                                                                                                                                                                                                                                                                                                                                                            #!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Sun May 14 18:17:39 2023

@author: samnot
"""

import numpy as np
import h5py
from scipy.spatial import distance
import multiprocessing as mp
import threading
import csv



centers = [[ 29.34690264, 16.7214    ,  11.33663627 , 13.64245588,  23.16986503,
   16.958701  , 14.09036736,  16.93861676 , 61.01867194,  24.78065119,
   11.77048472, 13.04924765,  21.53913121 , 16.07886506,  16.07318367,
   29.23639093, 87.02229569,  40.18573701 , 13.84608514,   8.76457512,
   10.28791995, 7.67118613 ,  10.87192931 , 33.269717  ,  44.29031156,
   27.53514664, 16.72415088,  15.37381877 , 19.12402704,   8.62912104,
    7.8173027 , 18.59944352,  37.14832234 , 20.2219092 ,  14.2648711 ,
   18.19617681, 27.87995202,  18.66451148 , 14.89755371,  19.86689189,
   75.913585  , 23.54619373,  11.28816676 , 19.61665511,  34.6914035 ,
   27.09335644, 21.02120443,  31.35850672 ,124.7110334 ,  40.71687169,
    9.71410859, 6.99295798 ,  10.37063249 ,  8.01641261,  11.83785989,
   48.43518169, 57.72556817,  27.96815564 , 15.77622863,  18.52259029,
   26.25502859, 13.25216628,   8.5596679  , 21.16321242,  37.13469333,
   19.87049393, 14.93932894,  18.72492213 , 27.86604503,  18.14750321,
   14.2611633 , 20.20817461,  75.88497962 , 31.35169377,  21.04466113,
   27.14082907, 34.70008551,  19.59793012 , 11.30382672,  23.55413997,
  124.67816477, 48.38165926,  11.82965255 ,  8.03014754,  10.36805281,
    6.99876131, 9.75595408 ,  40.78037717 , 57.72466086,  21.11011248,
    8.5355023 , 13.25673265,  26.24468145 , 18.51643164,  15.81155999,
   28.03667683, 29.33616625,  16.91406363 , 14.09321107,  16.98511388,
   23.17853154, 13.63535926,  11.37781006 , 16.74579984,  60.94520082,
   29.15105599, 16.05516449,  16.12438184 , 21.55839856,  13.07042573,
   11.8273381 , 24.81407922,  86.9594242  , 33.19573917,  10.86191699,
    7.67976962, 10.29269145,   8.7684033  , 13.89355622,  40.25307584,
   44.28715904, 18.57099762,   7.8051213  ,  8.61776377,  19.09782877,
   15.36590543, 16.77181745,  27.58805972],
 [ 31.88024978, 19.1864374 ,  12.76836413 , 12.96195753,  23.64971399,
   23.48936547, 24.18697223,  26.55419381 , 57.90174185,  32.07587501,
   18.22344921, 13.58619305,  16.00794555 , 18.36090552,  24.11464601,
   37.00251011, 33.06302642,  28.20953209 , 25.77254255,  24.41000007,
   26.20913442, 19.46751081,  20.145634   , 23.17451366,  19.10207734,
   17.78223143, 21.38982194,  23.38835237 , 24.67018436,  17.61084371,
   17.29338027, 18.26651807,  42.60926124 , 20.15671202,  12.9063743 ,
   19.43531227, 33.64235813,  28.83986496 , 23.87283589,  27.18678151,
  102.85743091, 48.77718844,  18.18417193 , 13.58693446,  16.26401916,
   16.41442482, 19.32594755,  39.76013064 , 54.99299049,  33.95803775,
   31.35437766, 36.90490585,  40.2841387  , 24.73345169,  17.25843573,
   22.8528578 , 24.29665754,  21.28069272 , 23.83205172,  28.80748615,
   32.95837719, 23.80408609,  18.95987494 , 20.14215258,  42.62184801,
   27.16403354, 23.84220918,  28.79306555 , 33.63874775,  19.49178582,
   12.91715654, 20.1589411 , 102.85602311 , 39.7744473 ,  19.30459451,
   16.36127539, 16.26118807,  13.61105309 , 18.18306066,  48.77834188,
   55.02713035, 22.89736301,  17.24974224 , 24.72129058,  40.28837851,
   36.8940499 , 31.30149825,  33.92103041 , 24.30239025,  20.17836364,
   18.9635441 , 23.7916305 ,  32.97239901 , 28.84618158,  23.79910355,
   21.20236079, 31.90013083,  26.54152138 , 24.16115599,  23.46370487,
   23.66493441, 12.94434885,  12.71464292 , 19.16654646,  57.9850274 ,
   37.05443426, 24.11798338,  18.32446119 , 15.99551162,  13.55116211,
   18.18005584, 32.0443897 ,  33.15968605 , 23.25220178,  20.16060661,
   19.45873745, 26.21013858,  24.38631513 , 25.71251013,  28.14874184,
   19.11204185, 18.30719215,  17.33490193 , 17.62780484,  24.69438435,
   23.39801568, 21.33577023,  17.7078788 ]]


f = h5py.File('./SIFT10Mfeatures.mat','r')
data = f.get('fea')
data = np.array(data)

dict_set = {
    'p1':[],
    'p2':[],
}

half = int(data.shape[0]/2)

def cal_dist_and_add_to_set(point:list, index:int):
    global dict_set
    dist_list = []
    for i in range(len(dict_set)):
        dist_list.append(distance.euclidean(point, centers[i]))
    
    index_novo = dist_list.index(min(dist_list))
    dict_set[f'p{index_novo+1}'].append(index)
    print(index)

def thread_func():
    global dict_set
    for i in range(0,half,1):
        point = data[i]
        cal_dist_and_add_to_set(point, i)
    print('FIM THREAD')


x = threading.Thread(target=thread_func)
x.start()

for j in range(half +1 ,data.shape[0],1):
    point = data[j]
    cal_dist_and_add_to_set(point, j)



#print(f'P1:{len(dict_set["p1"])}, P2:{len(dict_set["p2"])}, P3:{len(dict_set["p3"])}, P4:{len(dict_set["p4"])}')
#with open ("./novo.json","a") as arq:
#    json.dump(arq, dict_set)
#

print(dict_set['p1'])
header = ['gh']+[f'fea{i}' for i in range(128)]
for chave, valor in dict_set.items():
    with open(f'inserts_half_{chave}.csv', mode='w') as arq:
        arq = csv.writer(arq, delimiter=',', quotechar='"', quoting=csv.QUOTE_MINIMAL)
        arq.writerow(header)
        for item in valor:
            arq.writerow([chave[-1]]+[str(char_number) for char_number in data[item]])
        
        

# print(set_p1)
# def cal_dist_and_add_to_set(point:list):
#     global set_p1, set_p2
#     d_p1 = distance.euclidean(point, data[p1])
#     d_p2 = distance.euclidean(point, data[p2])
#     print(f'P1:{d_p1}, P2:{d_p2}')
#     if d_p1 != 0 and d_p2 != 0:
#         if d_p1 < d_p2 :
#             set_p1.append(point)
#             return 0
#         else:
#             set_p2.append(point)
#             return 1
            
  
# with mp.Pool(4) as p:
#     p.map(cal_dist_and_add_to_set, data)

